<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–î–∏—Å–ø–µ—Ç—á–µ—Ä</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="card">
    <h2>–°–≤–æ–¥–∫–∏ –±—É—Ä–æ–≤–∏–∫–æ–≤</h2>
    <div class="top-actions">
      <a class="btn" href="/export_excel">üìä –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –≤ Excel</a>
      <button id="showUsersBtn" class="btn">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
      <a class="btn danger" href="/logout">üö™ –í—ã—Ö–æ–¥</a>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th><th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th><th>MBU</th><th>–ù–æ–º–µ—Ä –±—É—Ä–æ–≤–æ–π</th><th>–ú–µ—Ç—Ä–∞–∂</th><th>–ü–æ–≥–æ–Ω–æ–º–µ—Ç—Ä</th><th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ</th><th>created_at</th>
        </tr>
      </thead>
      <tbody id="reportsBody">
        {% for r in reports %}
        <tr>
          <td>{{ r.id }}</td>
          <td>{{ r.date_time }}</td>
          <td>{{ r.location }}</td>
          <td>{{ r.rig_number }}</td>
          <td>{{ r.meterage }}</td>
          <td>{{ r.pogon }}</td>
          <td>{{ r.note }}</td>
          <td>{{ r.operator_name }}</td>
          <td>{{ r.created_at }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div id="usersPanel" class="card users" style="display:none">
      <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
      <form id="createUserForm">
        <label>–õ–æ–≥–∏–Ω</label><input name="username" required>
        <label>–ü–∞—Ä–æ–ª—å</label><input name="password" type="password" required>
        <label>–†–æ–ª—å</label><select name="role"><option value="driller">driller</option><option value="dispatcher">dispatcher</option><option value="admin">admin</option></select>
        <div><button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button></div>
      </form>
      <table id="usersTable">
        <thead><tr><th>ID</th><th>–õ–æ–≥–∏–Ω</th><th>–†–æ–ª—å</th><th>–°–æ–∑–¥–∞–Ω</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
        <tbody>
        {% for u in users %}
          <tr>
            <td>{{ u.id }}</td>
            <td>{{ u.username }}</td>
            <td>{{ u.role }}</td>
            <td>{{ u.created_at }}</td>
            <td><button class="del" data-id="{{ u.id }}">–£–¥–∞–ª–∏—Ç—å</button></td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

<script>
const showUsersBtn = document.getElementById('showUsersBtn');
const usersPanel = document.getElementById('usersPanel');
showUsersBtn.addEventListener('click', ()=>{
  usersPanel.style.display = usersPanel.style.display === 'none' ? 'block' : 'none';
});

const createUserForm = document.getElementById('createUserForm');
createUserForm?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(createUserForm);
  const res = await fetch('/api/users', { method:'POST', body: new URLSearchParams(fd) });
  if(res.ok) location.reload(); else alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
});

document.querySelectorAll('.del').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const id = btn.dataset.id;
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
    const res = await fetch('/api/users/' + id, { method:'DELETE' });
    if(res.ok) location.reload(); else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
  });
});
</script>
</body>
</html>